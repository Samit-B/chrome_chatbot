document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".theme-toggle"),t=document.body;let n=!1;e.addEventListener("click",(()=>{n=!n,t.setAttribute("data-theme",n?"dark":"light"),e.innerHTML=n?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>'}));const s=document.getElementById("chatContainer"),o=document.querySelector(".message-input"),a=document.querySelector(".send-button"),i=document.querySelector(".typing-indicator"),c=document.getElementById("fileInput");let r,l=null,d=!1;"webkitSpeechRecognition"in window&&(r=new webkitSpeechRecognition,r.continuous=!1,r.interimResults=!1,r.lang="en-US",r.onresult=e=>{const t=e.results[0][0].transcript;o.value=t},r.onerror=e=>{console.error("Speech recognition error:",e.error)});const p=document.querySelector(".voice-toggle");function u(e){return e.split("\n").map((e=>((e=e.trim()).startsWith("*")&&(e=`â€¢ ${e.substring(1).trim()}`),`<p>${e}</p>`))).join("")}function m(e,t=!1,n=!1){const o=function(e,t=!1,n=!1){const s=document.createElement("div");s.className="message "+(t?"user-message":"bot-message");const o=document.createElement("div");o.className="avatar",o.textContent=t?"U":"AI";const a=document.createElement("div");if(a.className="message-bubble",n){const t=document.createElement("div");t.className="file-attachment",t.innerHTML=`\n        <i class="fas fa-file"></i>\n        <span>${e}</span>\n      `,a.appendChild(t)}else a.innerHTML=u(e);const i=document.createElement("div");i.className="message-actions";const c=document.createElement("button");c.className="copy-button",c.innerHTML='<i class="fas fa-copy"></i>',c.title="Copy to Clipboard",c.addEventListener("click",(()=>{navigator.clipboard.writeText(e)}));let r=null;const l=document.createElement("button");if(l.className="voice-button",l.innerHTML='<i class="fas fa-volume-up"></i>',l.title="Play Message",l.addEventListener("click",(()=>{speechSynthesis.speaking?(speechSynthesis.cancel(),r=null,l.classList.remove("playing")):(r=new SpeechSynthesisUtterance(e),r.lang="en-US",r.onend=()=>{l.classList.remove("playing")},speechSynthesis.speak(r),l.classList.add("playing"))})),i.appendChild(c),i.appendChild(l),t){const t=document.createElement("button");t.className="edit-button",t.innerHTML='<i class="fas fa-edit"></i>',t.title="Edit Message",t.addEventListener("click",(()=>{const t=e,n=document.createElement("textarea");n.className="editable-input",n.value=t;const o=document.createElement("button");o.className="send-icon",o.innerHTML='<i class="fas fa-paper-plane"></i>',o.title="Send Edited Message",a.innerHTML="",a.appendChild(n),a.appendChild(o),n.focus();const c=async()=>{const e=n.value.trim();if(e){let t=s.nextSibling;for(;t;){const e=t.nextSibling;t.remove(),t=e}a.innerHTML=u(e),a.appendChild(i),await y(e)}else a.innerHTML=u(t),a.appendChild(i)};o.addEventListener("click",c),n.addEventListener("keypress",(e=>{"Enter"===e.key&&(e.preventDefault(),c())}))})),i.appendChild(t)}return a.appendChild(i),s.appendChild(o),s.appendChild(a),s}(e,t,n);s.appendChild(o),s.scrollTop=s.scrollHeight}function h(){i.style.display="none"}async function y(e){i.style.display="block",s.scrollTop=s.scrollHeight;try{let t=await fetch(`http://localhost:8000/chat/query?userChatQuery=${encodeURIComponent(e)}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch response from server.");let n=await t.json();h(),m(n.response)}catch(e){h(),m("Sorry, I couldn't fetch a response. Please try again later."),console.error("Error:",e)}}async function g(){const e=o.value.trim();(e||l)&&(l?(m(l.name,!0,!0),await async function(e,t){const n=new FormData;n.append("file",e),n.append("query",t);try{const e=await fetch("http://localhost:8000/pdf/query",{method:"POST",body:n});if(!e.ok)throw new Error("Error processing PDF query.");m(`ðŸ“„ Answer from PDF:\n${(await e.json()).answer}`,!1)}catch(e){m("Error retrieving PDF data. Please try again.",!1),console.error("PDF Query Error:",e)}}(l,e),l=null):(m(e,!0),await y(e)),o.value="")}p.addEventListener("click",(()=>{r?d?(r.stop(),p.classList.remove("recording"),d=!1):(r.start(),p.classList.add("recording"),d=!0):alert("Speech recognition is not supported in this browser.")})),a.addEventListener("click",g),o.addEventListener("keypress",(e=>{"Enter"===e.key&&g()})),c.addEventListener("change",(e=>{const t=e.target.files[0];if(t){l=t;const e=document.querySelector(".file-attachment");e&&e.remove();const n=document.createElement("div");n.className="file-attachment",n.innerHTML=`\n        <i class="fas fa-file"></i>\n        <span>${t.name}</span>\n        <button class="remove-file" aria-label="Remove file">&times;</button>\n      `,o.parentNode.appendChild(n),n.querySelector(".remove-file").addEventListener("click",(()=>{n.remove(),l=null,c.value=""}))}})),setTimeout((()=>{m("Hello! I'm your AI assistant. How can I help you today?")}),500),a&&a.addEventListener("click",(()=>{const e=o.value.trim();e&&console.log("Message sent:",e)})),document.getElementById("voiceAssistant").addEventListener("click",(function(){document.querySelector(".page-container").style.transform="translateX(-100vw)"})),document.getElementById("backButton").addEventListener("click",(function(){document.querySelector(".page-container").style.transform="translateX(0)"}));const f=document.getElementById("talk-assistant-btn");let v=!1,E=null;function L(){v||(r.start(),v=!0,k(f,"listening"),f.textContent="Listening...",E=setTimeout((()=>{S()}),6e4))}function S(){r.stop(),clearTimeout(E),v=!1,k(f,null),f.textContent="Talk Assistant"}function k(e,t){if(e.classList.remove("listening","processing","replaying"),document.querySelectorAll(".voice-assistant-container video").forEach((e=>{e.pause(),e.classList.remove("active")})),t){e.classList.add(t);const n=document.getElementById(`${t}Video`);n&&(n.classList.add("active"),n.play())}}f.addEventListener("click",(()=>{r?v?S():L():alert("Speech recognition is not supported in this browser.")})),r.onstart=()=>{console.log("Recognition started"),speechSynthesis.speaking&&(console.log("User interrupted â€” bot stopped"),speechSynthesis.cancel())},r.onresult=async e=>{clearTimeout(E);const t=e.results[0][0].transcript;console.log("User Query:",t),m(t,!0),k(f,"processing"),f.textContent="Processing...";try{const e=await fetch(`http://localhost:8000/chat/query?userChatQuery=${encodeURIComponent(t)}`),n=(await e.json()).response;m(n,!1);const s=new SpeechSynthesisUtterance(n);s.lang="en-US",s.onstart=()=>{k(f,"replaying"),f.textContent="Replaying..."},s.onend=()=>{k(f,null),f.textContent="Listening...",L()},speechSynthesis.speak(s)}catch(e){console.error("Fetch or speak error:",e),m("Sorry, something went wrong.",!1),L()}},r.onerror=e=>{console.error("Recognition error:",e.error),S(),speechSynthesis.speaking||setTimeout((()=>{L()}),1e3)},r.onend=()=>{v=!1},document.getElementById("stop-assistant-btn").addEventListener("click",(()=>{S(),(speechSynthesis.speaking||speechSynthesis.pending)&&speechSynthesis.cancel(),k(f,null),f.textContent="Talk Assistant"}))}));