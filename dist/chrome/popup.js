document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".theme-toggle"),t=document.body;let n=!1;e.addEventListener("click",(()=>{n=!n,t.setAttribute("data-theme",n?"dark":"light"),e.innerHTML=n?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>'}));const a=document.getElementById("chatContainer"),s=document.querySelector(".message-input"),o=document.querySelector(".send-button"),i=document.querySelector(".typing-indicator"),r=document.getElementById("fileInput");let c,l=null,d=!1;"webkitSpeechRecognition"in window&&(c=new webkitSpeechRecognition,c.continuous=!1,c.interimResults=!1,c.lang="en-US",c.onresult=e=>{const t=e.results[0][0].transcript;s.value=t},c.onerror=e=>{console.error("Speech recognition error:",e.error)});const u=document.querySelector(".voice-toggle");function p(e){return e.split("\n").map((e=>((e=e.trim()).startsWith("*")&&(e=`â€¢ ${e.substring(1).trim()}`),`<p>${e}</p>`))).join("")}function m(e,t=!1,n=!1){const s=function(e,t=!1,n=!1){const a=document.createElement("div");a.className="message "+(t?"user-message":"bot-message");const s=document.createElement("div");s.className="avatar",s.textContent=t?"U":"AI";const o=document.createElement("div");if(o.className="message-bubble",n){const t=document.createElement("div");t.className="file-attachment",t.innerHTML=`\n        <i class="fas fa-file"></i>\n        <span>${e}</span>\n      `,o.appendChild(t)}else o.innerHTML=p(e);const i=document.createElement("div");i.className="message-actions";const r=document.createElement("button");r.className="copy-button",r.innerHTML='<i class="fas fa-copy"></i>',r.title="Copy to Clipboard",r.addEventListener("click",(()=>{navigator.clipboard.writeText(e)}));let c=null;const l=document.createElement("button");if(l.className="voice-button",l.innerHTML='<i class="fas fa-volume-up"></i>',l.title="Play Message",l.addEventListener("click",(()=>{speechSynthesis.speaking?(speechSynthesis.cancel(),c=null,l.classList.remove("playing")):(c=new SpeechSynthesisUtterance(e),c.lang="en-US",speechSynthesis.speak(c),l.classList.add("playing"))})),i.appendChild(r),i.appendChild(l),t){const t=document.createElement("button");t.className="edit-button",t.innerHTML='<i class="fas fa-edit"></i>',t.title="Edit Message",t.addEventListener("click",(()=>{const t=e,n=document.createElement("textarea");n.className="editable-input",n.value=t;const s=document.createElement("button");s.className="send-icon",s.innerHTML='<i class="fas fa-paper-plane"></i>',s.title="Send Edited Message",o.innerHTML="",o.appendChild(n),o.appendChild(s),n.focus();const r=async()=>{const e=n.value.trim();if(e){let t=a.nextSibling;for(;t;){const e=t.nextSibling;t.remove(),t=e}o.innerHTML=p(e),o.appendChild(i),await f(e)}else o.innerHTML=p(t),o.appendChild(i)};s.addEventListener("click",r),n.addEventListener("keypress",(e=>{"Enter"===e.key&&(e.preventDefault(),r())}))})),i.appendChild(t)}return o.appendChild(i),a.appendChild(s),a.appendChild(o),a}(e,t,n);a.appendChild(s),a.scrollTop=a.scrollHeight}function h(){i.style.display="none"}async function f(e){i.style.display="block",a.scrollTop=a.scrollHeight;try{let t=await fetch(`http://localhost:8000/chat/query?userChatQuery=${encodeURIComponent(e)}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch response from server.");let n=await t.json();h(),m(n.response)}catch(e){h(),m("Sorry, I couldn't fetch a response. Please try again later."),console.error("Error:",e)}}async function y(){const e=s.value.trim();(e||l)&&(l?(m(l.name,!0,!0),await async function(e,t){const n=new FormData;n.append("file",e),n.append("query",t);try{const e=await fetch("http://localhost:8000/pdf/query",{method:"POST",body:n});if(!e.ok)throw new Error("Error processing PDF query.");m(`ðŸ“„ Answer from PDF:\n${(await e.json()).answer}`,!1)}catch(e){m("Error retrieving PDF data. Please try again.",!1),console.error("PDF Query Error:",e)}}(l,e),l=null):(m(e,!0),await f(e)),s.value="")}u.addEventListener("click",(()=>{c?d?(c.stop(),u.classList.remove("recording"),d=!1):(c.start(),u.classList.add("recording"),d=!0):alert("Speech recognition is not supported in this browser.")})),o.addEventListener("click",y),s.addEventListener("keypress",(e=>{"Enter"===e.key&&y()})),r.addEventListener("change",(e=>{const t=e.target.files[0];if(t){l=t;const e=document.querySelector(".file-attachment");e&&e.remove();const n=document.createElement("div");n.className="file-attachment",n.innerHTML=`\n        <i class="fas fa-file"></i>\n        <span>${t.name}</span>\n        <button class="remove-file" aria-label="Remove file">&times;</button>\n      `,s.parentNode.appendChild(n),n.querySelector(".remove-file").addEventListener("click",(()=>{n.remove(),l=null,r.value=""}))}})),setTimeout((()=>{m("Hello! I'm your AI assistant. How can I help you today?")}),500),o&&o.addEventListener("click",(()=>{const e=s.value.trim();e&&console.log("Message sent:",e)}))}));